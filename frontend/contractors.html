<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contractors | GRAM-SABHA</title>
    <meta name="description" content="Manage registered contractors for village development projects">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/admin.css">
    <style>
    /* ‚îÄ‚îÄ Contractors Page Premium Styles ‚îÄ‚îÄ */
    :root {
      --cn-green: #16a34a; --cn-green-light: #dcfce7; --cn-green-bg: #f0fdf4;
      --cn-shadow: 0 4px 24px -4px rgba(0,0,0,.08), 0 1px 4px rgba(0,0,0,.04);
      --cn-shadow-lg: 0 20px 60px -12px rgba(0,0,0,.15);
      --cn-radius: 1.375rem; --cn-transition: all .22s cubic-bezier(.4,0,.2,1);
    }

    /* ‚îÄ‚îÄ Top Controls ‚îÄ‚îÄ */
    .ct-controls {
      display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;
      background: white; border-radius: var(--cn-radius);
      padding: 1.125rem 1.5rem;
      box-shadow: var(--cn-shadow); margin-bottom: 1.5rem;
      border: 1px solid rgba(0,0,0,.04);
    }
    .ct-search {
      display: flex; align-items: center; gap: .5rem;
      padding: .5625rem 1rem; flex: 1; min-width: 200px;
      background: #f8fafc; border: 1.5px solid #e2e8f0;
      border-radius: 999px; transition: var(--cn-transition);
    }
    .ct-search:focus-within { border-color: var(--cn-green); box-shadow: 0 0 0 3px rgba(22,163,74,.1); background: white; }
    .ct-search .material-symbols-outlined { color: #94a3b8; font-size: 1.125rem; flex-shrink: 0; }
    .ct-search input { border: none; background: transparent; outline: none; font-family: inherit; font-size: .875rem; color: #0f172a; width: 100%; }
    .ct-search input::placeholder { color: #94a3b8; }

    .ct-filter-group { display: flex; align-items: center; gap: .5rem; }
    .ct-filter-btn {
      padding: .5rem 1rem; border-radius: 999px;
      font-size: .8125rem; font-weight: 700; font-family: inherit;
      cursor: pointer; transition: var(--cn-transition);
      border: 1.5px solid #e2e8f0; background: white; color: #475569;
    }
    .ct-filter-btn:hover, .ct-filter-btn.active {
      background: var(--cn-green-bg); border-color: var(--cn-green); color: var(--cn-green);
    }

    .ct-sort-select {
      padding: .5rem .875rem; border-radius: 999px;
      font-size: .8125rem; font-weight: 600; font-family: inherit;
      border: 1.5px solid #e2e8f0; background: white; color: #475569;
      cursor: pointer; outline: none; transition: var(--cn-transition);
    }
    .ct-sort-select:focus { border-color: var(--cn-green); }

    .ct-add-btn {
      display: flex; align-items: center; gap: .5rem;
      padding: .5625rem 1.25rem;
      background: var(--cn-green); color: white;
      border: none; border-radius: 999px;
      font-size: .875rem; font-weight: 700; font-family: inherit;
      cursor: pointer; transition: var(--cn-transition);
      margin-left: auto;
    }
    .ct-add-btn:hover { background: #15803d; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(22,163,74,.35); }
    .ct-add-btn .material-symbols-outlined { font-size: 1.0625rem; }

    /* ‚îÄ‚îÄ Summary Bar ‚îÄ‚îÄ */
    .ct-summary {
      display: grid; grid-template-columns: repeat(4,1fr); gap: 1rem; margin-bottom: 1.5rem;
    }
    .ct-sum-card {
      background: white; border-radius: 1.125rem; padding: 1rem 1.25rem;
      box-shadow: var(--cn-shadow); border: 1px solid rgba(0,0,0,.04);
      display: flex; align-items: center; gap: .875rem;
      transition: var(--cn-transition);
    }
    .ct-sum-card:hover { transform: translateY(-2px); box-shadow: var(--cn-shadow-lg); }
    .ct-sum-icon { width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .ct-sum-icon .material-symbols-outlined { font-size: 1.25rem; }
    .ct-sum-icon.green  { background: var(--cn-green-light); color: var(--cn-green); }
    .ct-sum-icon.blue   { background: #dbeafe; color: #3b82f6; }
    .ct-sum-icon.orange { background: #ffedd5; color: #f97316; }
    .ct-sum-icon.purple { background: #ede9fe; color: #8b5cf6; }
    .ct-sum-val { font-size: 1.5rem; font-weight: 900; color: #0f172a; line-height: 1; }
    .ct-sum-lbl { font-size: .6875rem; color: #64748b; font-weight: 600; margin-top: .1rem; }

    /* ‚îÄ‚îÄ Grid ‚îÄ‚îÄ */
    .ct-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.25rem;
    }

    /* ‚îÄ‚îÄ Contractor Card ‚îÄ‚îÄ */
    .ct-card {
      background: white; border-radius: var(--cn-radius);
      border: 1.5px solid #f1f5f9;
      box-shadow: var(--cn-shadow);
      display: flex; flex-direction: column;
      overflow: hidden; transition: var(--cn-transition);
      position: relative;
    }
    .ct-card:hover { transform: translateY(-4px); box-shadow: var(--cn-shadow-lg); border-color: var(--cn-green-light); }

    /* Card banner */
    .ct-card-banner {
      height: 6px; width: 100%;
    }

    /* Status badge */
    .ct-card-header { display: flex; align-items: flex-start; justify-content: space-between; padding: 1.25rem 1.25rem .75rem; }
    .ct-avatar {
      width: 56px; height: 56px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1875rem; font-weight: 900; color: white;
      box-shadow: 0 8px 20px rgba(0,0,0,.2); flex-shrink: 0;
    }
    .ct-status-tag {
      display: flex; align-items: center; gap: .3rem;
      padding: .3rem .75rem; border-radius: 999px;
      font-size: .6875rem; font-weight: 800;
    }
    .ct-status-tag.available { background: var(--cn-green-light); color: #166534; }
    .ct-status-tag.busy      { background: #fef3c7; color: #92400e; }
    .ct-status-tag .material-symbols-outlined { font-size: .875rem; }

    /* Info */
    .ct-info { padding: 0 1.25rem .75rem; }
    .ct-name { font-size: 1.0625rem; font-weight: 900; color: #0f172a; margin: 0 0 .175rem; }
    .ct-type { font-size: .8125rem; color: #64748b; font-weight: 600; margin: 0 0 .625rem; }

    /* Stars */
    .ct-rating { display: flex; align-items: center; gap: .375rem; margin-bottom: .75rem; }
    .ct-stars { font-size: .9rem; letter-spacing: -.05em; }
    .ct-rating-val { font-size: .8125rem; font-weight: 800; color: #0f172a; }
    .ct-rating-cnt { font-size: .75rem; color: #94a3b8; font-weight: 500; }

    /* Mini stats */
    .ct-stats-row { display: flex; gap: .5rem; margin-bottom: .875rem; }
    .ct-mini-stat {
      flex: 1; text-align: center; padding: .625rem .375rem;
      background: #f8fafc; border-radius: .75rem;
      border: 1px solid #f1f5f9;
    }
    .ct-mini-val { font-size: 1rem; font-weight: 900; color: #0f172a; display: block; }
    .ct-mini-lbl { font-size: .6rem; font-weight: 700; text-transform: uppercase; letter-spacing: .06em; color: #94a3b8; display: block; }

    /* On-time bar */
    .ct-ontime-row { display: flex; flex-direction: column; gap: .3rem; margin-bottom: .875rem; }
    .ct-ontime-top { display: flex; justify-content: space-between; align-items: center; }
    .ct-ontime-label { font-size: .75rem; font-weight: 700; color: #475569; }
    .ct-ontime-pct   { font-size: .75rem; font-weight: 800; color: var(--cn-green); }
    .ct-ontime-bar { height: 6px; border-radius: 999px; background: #e2e8f0; overflow: hidden; }
    .ct-ontime-fill { height: 100%; border-radius: 999px; background: linear-gradient(90deg,#22c55e,#16a34a); }

    /* Specialties */
    .ct-tags { display: flex; flex-wrap: wrap; gap: .375rem; padding: 0 1.25rem .875rem; }
    .ct-tag {
      padding: .25rem .625rem; border-radius: 999px;
      font-size: .6875rem; font-weight: 700;
      background: #f1f5f9; color: #475569;
      border: 1px solid #e2e8f0;
    }

    /* Contact */
    .ct-contact {
      display: flex; gap: 1rem; padding: .75rem 1.25rem;
      border-top: 1px solid #f8fafc; border-bottom: 1px solid #f8fafc;
    }
    .ct-contact-item {
      display: flex; align-items: center; gap: .35rem;
      font-size: .75rem; color: #64748b; font-weight: 600;
    }
    .ct-contact-item .material-symbols-outlined { font-size: .9375rem; color: var(--cn-green); }
    .ct-contact-item a { color: inherit; text-decoration: none; }
    .ct-contact-item a:hover { color: var(--cn-green); }

    /* Actions */
    .ct-actions { display: flex; gap: .625rem; padding: .875rem 1.25rem; }
    .ct-btn-profile {
      flex: 1; padding: .5625rem; border-radius: .75rem;
      font-size: .8125rem; font-weight: 700; font-family: inherit;
      cursor: pointer; transition: var(--cn-transition);
      border: 1.5px solid #e2e8f0; background: white; color: #475569;
      display: flex; align-items: center; justify-content: center; gap: .375rem;
    }
    .ct-btn-profile:hover { border-color: #94a3b8; background: #f8fafc; }
    .ct-btn-profile .material-symbols-outlined { font-size: .9375rem; }

    .ct-btn-assign {
      flex: 1.2; padding: .5625rem; border-radius: .75rem;
      font-size: .8125rem; font-weight: 700; font-family: inherit;
      cursor: pointer; transition: var(--cn-transition);
      border: none; color: white;
      background: linear-gradient(135deg, var(--cn-green), #22c55e);
      display: flex; align-items: center; justify-content: center; gap: .375rem;
    }
    .ct-btn-assign:hover { background: linear-gradient(135deg,#15803d,#16a34a); transform: translateY(-1px); box-shadow: 0 6px 16px rgba(22,163,74,.35); }
    .ct-btn-assign .material-symbols-outlined { font-size: .9375rem; }
    .ct-btn-assign.busy-btn { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; box-shadow: none; transform: none; }

    /* Performance badge */
    .ct-perf-badge {
      position: absolute; top: 1rem; right: 1rem;
      width: 28px; height: 28px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: .875rem; cursor: default;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
    }
    .ct-perf-badge[title] { cursor: help; }

    /* Empty / no-results */
    .ct-empty {
      grid-column: 1/-1; text-align: center; padding: 3rem;
      background: white; border-radius: var(--cn-radius);
      box-shadow: var(--cn-shadow);
    }
    .ct-empty .material-symbols-outlined { font-size: 3rem; color: #cbd5e1; display: block; margin-bottom: 1rem; }
    .ct-empty p { color: #94a3b8; font-size: .9375rem; }

    /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
    @media (max-width: 768px) {
      .ct-summary { grid-template-columns: repeat(2,1fr); }
      .ct-controls { flex-direction: column; align-items: stretch; }
      .ct-add-btn { margin-left: 0; }
    }
    </style>
</head>
<body class="admin-body">
<div class="admin-layout">

    <!-- Sidebar (standard admin sidebar) -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="index.html" class="sidebar-logo">
                <div class="sidebar-logo-icon" aria-hidden="true">
                    <span class="material-symbols-outlined">account_balance</span>
                </div>
                <div class="sidebar-logo-text">
                    <p class="sidebar-brand-name"><strong>GRAM-SABHA</strong></p>
                    <p>Sarpanch Portal</p>
                </div>
            </a>
        </div>

        <nav class="sidebar-nav" aria-label="Main navigation">
            <a href="sarpanch-portal.html" class="nav-item">
                <span class="material-symbols-outlined" aria-hidden="true">dashboard</span>
                <span>Dashboard</span>
            </a>
            <a href="pending-approvals.html" class="nav-item">
                <span class="material-symbols-outlined" aria-hidden="true">task_alt</span>
                <span>Pending Approvals</span>
                <span class="nav-badge" aria-label="5 pending">5</span>
            </a>
            <a href="active-projects.html" class="nav-item">
                <span class="material-symbols-outlined" aria-hidden="true">construction</span>
                <span>Active Projects</span>
            </a>
            <a href="public-ledger.html" class="nav-item">
                <span class="material-symbols-outlined" aria-hidden="true">account_balance_wallet</span>
                <span>Budget &amp; Funds</span>
            </a>
            <a href="community-issues.html" class="nav-item">
                <span class="material-symbols-outlined" aria-hidden="true">campaign</span>
                <span>Community Issues</span>
                <span class="nav-badge warning" aria-label="12 issues">12</span>
            </a>
            <a href="contractor-verification.html" class="nav-item">
                <span class="material-symbols-outlined" aria-hidden="true">verified</span>
                <span>Work Verification</span>
            </a>
            <a href="contractors.html" class="nav-item active" aria-current="page">
                <span class="material-symbols-outlined" aria-hidden="true">groups</span>
                <span>Contractors</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="sidebar-user">
                <div class="sidebar-avatar" id="sidebarAvatar" aria-hidden="true">RK</div>
                <div class="sidebar-user-info">
                    <p class="sidebar-user-name" id="sidebarUserName">Ramesh Kumar</p>
                    <p class="sidebar-user-role" id="sidebarUserRole">Sarpanch</p>
                </div>
                <button onclick="GramSabha.logout()" class="sidebar-logout" aria-label="Logout">
                    <span class="material-symbols-outlined" aria-hidden="true">logout</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main -->
    <main class="admin-main">
        <header class="admin-header">
            <div class="header-title">
                <h1 class="page-heading">Contractors</h1>
                <p id="contractorSubtitle">6 registered contractors ‚Ä¢ 4 available</p>
            </div>
            <div class="header-actions">
                <button class="ct-add-btn" id="addContractorBtn" aria-label="Add new contractor">
                    <span class="material-symbols-outlined" aria-hidden="true">person_add</span>
                    Add Contractor
                </button>
            </div>
        </header>

        <div class="admin-content">

            <!-- Summary Row -->
            <div class="ct-summary" role="list" aria-label="Contractor statistics">
                <div class="ct-sum-card" role="listitem">
                    <div class="ct-sum-icon green" aria-hidden="true"><span class="material-symbols-outlined">groups</span></div>
                    <div><p class="ct-sum-val" id="statTotal">6</p><p class="ct-sum-lbl">Total Registered</p></div>
                </div>
                <div class="ct-sum-card" role="listitem">
                    <div class="ct-sum-icon blue" aria-hidden="true"><span class="material-symbols-outlined">person_check</span></div>
                    <div><p class="ct-sum-val" id="statAvail">4</p><p class="ct-sum-lbl">Available Now</p></div>
                </div>
                <div class="ct-sum-card" role="listitem">
                    <div class="ct-sum-icon orange" aria-hidden="true"><span class="material-symbols-outlined">engineering</span></div>
                    <div><p class="ct-sum-val" id="statBusy">2</p><p class="ct-sum-lbl">On Active Project</p></div>
                </div>
                <div class="ct-sum-card" role="listitem">
                    <div class="ct-sum-icon purple" aria-hidden="true"><span class="material-symbols-outlined">workspace_premium</span></div>
                    <div><p class="ct-sum-val">‚Çπ1.57 Cr</p><p class="ct-sum-lbl">Total Work Value</p></div>
                </div>
            </div>

            <!-- Controls -->
            <div class="ct-controls">
                <div class="ct-search" role="search">
                    <span class="material-symbols-outlined" aria-hidden="true">search</span>
                    <input type="search" id="searchInput" placeholder="Search by name, specialty, location‚Ä¶" aria-label="Search contractors">
                </div>
                <div class="ct-filter-group" role="group" aria-label="Filter by availability">
                    <button class="ct-filter-btn active" data-filter="all" aria-pressed="true">All</button>
                    <button class="ct-filter-btn" data-filter="available" aria-pressed="false">Available</button>
                    <button class="ct-filter-btn" data-filter="busy" aria-pressed="false">On Project</button>
                </div>
                <select class="ct-sort-select" id="sortSelect" aria-label="Sort contractors">
                    <option value="rating">Sort: Rating</option>
                    <option value="projects">Sort: Projects</option>
                    <option value="value">Sort: Work Value</option>
                    <option value="ontime">Sort: On-Time %</option>
                </select>
            </div>

            <!-- Contractor Cards -->
            <div class="ct-grid" id="contractorGrid" role="list" aria-label="Contractor cards">
                <!-- Cards rendered by JS -->
            </div>

        </div>
    </main>
</div>

<!-- ‚îÄ‚îÄ Profile Drawer (slide-in panel) ‚îÄ‚îÄ -->
<div id="profileDrawer" style="
    position:fixed; inset:0; z-index:500; display:none;
" aria-modal="true" role="dialog" aria-label="Contractor profile">
    <div id="drawerBackdrop" onclick="closeDrawer()" style="position:absolute;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(4px)"></div>
    <aside id="drawerPanel" style="
        position:absolute; top:0; right:0; bottom:0; width:min(480px,100vw);
        background:white; box-shadow: -20px 0 60px rgba(0,0,0,.2);
        overflow-y:auto; padding:1.75rem;
        transform:translateX(100%); transition:transform .3s cubic-bezier(.4,0,.2,1);
    ">
        <div id="drawerContent"></div>
    </aside>
</div>

<script src="js/auth.js" data-api-base="http://127.0.0.1:5000"></script>
<script src="js/app.js"></script>
<script src="js/mobile.js"></script>
<script>
'use strict';

/* ‚îÄ‚îÄ Data ‚îÄ‚îÄ */
var contractors = [
    {
        id: 1, initials: 'SC', name: 'Sharma Constructions', type: 'General Construction',
        rating: 4.8, ratingCount: 23, projects: 23, value: '‚Çπ45L', valueNum: 45,
        onTime: 96, status: 'available',
        specialties: ['Water Supply','Roads','Buildings','Foundation'],
        phone: '98765 43210', location: 'Jaipur',
        licenseNo: 'RAJ-CON-2019-0042', gstNo: '08AABCS1429B1Z1',
        gradient: 'linear-gradient(135deg,#16a34a,#22c55e)',
        banner: 'linear-gradient(90deg,#16a34a,#22c55e)',
        perfBadge: 'üèÜ', perfTitle: 'Top Performer',
        completedProjects: [
            { name: 'Water Tank ‚Äî Ward 2', year: 2023, value: '‚Çπ8.2L', status: 'Verified' },
            { name: 'Road Repair ‚Äî Main Market', year: 2022, value: '‚Çπ4.5L', status: 'Verified' },
        ]
    },
    {
        id: 2, initials: 'DC', name: 'Devi Construction', type: 'Building & Infrastructure',
        rating: 4.9, ratingCount: 18, projects: 18, value: '‚Çπ32L', valueNum: 32,
        onTime: 100, status: 'busy',
        specialties: ['Schools','Community Centers','Boundary Walls'],
        phone: '98765 12345', location: 'Rampur',
        licenseNo: 'RAJ-CON-2018-0081', gstNo: '08AABCD1234B1Z2',
        gradient: 'linear-gradient(135deg,#7c3aed,#9333ea)',
        banner: 'linear-gradient(90deg,#7c3aed,#9333ea)',
        perfBadge: '‚≠ê', perfTitle: '100% On-Time',
        completedProjects: [
            { name: 'School Boundary Wall', year: 2024, value: '‚Çπ1.85L', status: 'Awaiting Verification' },
            { name: 'Community Hall Roof', year: 2022, value: '‚Çπ6.1L', status: 'Verified' },
        ]
    },
    {
        id: 3, initials: 'GC', name: 'Gupta Contractors', type: 'Road & Highway',
        rating: 4.5, ratingCount: 15, projects: 15, value: '‚Çπ28L', valueNum: 28,
        onTime: 87, status: 'available',
        specialties: ['Roads','Drainage','Footpaths','Culverts'],
        phone: '99887 65432', location: 'Jaipur',
        licenseNo: 'RAJ-CON-2020-0033', gstNo: '08AABCG5566B1Z3',
        gradient: 'linear-gradient(135deg,#ea580c,#f97316)',
        banner: 'linear-gradient(90deg,#ea580c,#f97316)',
        perfBadge: null,
        completedProjects: [
            { name: 'School Road Repair', year: 2024, value: '‚Çπ2.25L', status: 'In Progress' },
        ]
    },
    {
        id: 4, initials: 'SB', name: 'Singh Builders', type: 'Sanitation & Plumbing',
        rating: 4.3, ratingCount: 12, projects: 12, value: '‚Çπ18L', valueNum: 18,
        onTime: 92, status: 'available',
        specialties: ['Toilets','Sewage','Water Tanks','Pipelines'],
        phone: '98123 45678', location: 'Sanganer',
        licenseNo: 'RAJ-CON-2021-0017', gstNo: '08AABCS7788B1Z4',
        gradient: 'linear-gradient(135deg,#0891b2,#06b6d4)',
        banner: 'linear-gradient(90deg,#0891b2,#06b6d4)',
        perfBadge: null,
        completedProjects: [
            { name: 'Community Toilets Block', year: 2023, value: '‚Çπ3.4L', status: 'Verified' },
        ]
    },
    {
        id: 5, initials: 'GS', name: 'Green Solutions', type: 'Eco & Sustainability',
        rating: 4.7, ratingCount: 8, projects: 8, value: '‚Çπ12L', valueNum: 12,
        onTime: 100, status: 'available',
        specialties: ['Rainwater','Solar','Gardens','Green Roofs'],
        phone: '99001 23456', location: 'Jaipur',
        licenseNo: 'RAJ-CON-2022-0009', gstNo: '08AABCG9900B1Z5',
        gradient: 'linear-gradient(135deg,#059669,#10b981)',
        banner: 'linear-gradient(90deg,#059669,#10b981)',
        perfBadge: 'üå±', perfTitle: 'Eco Certified',
        completedProjects: [
            { name: 'Rainwater Harvesting Unit', year: 2023, value: '‚Çπ2.1L', status: 'Verified' },
        ]
    },
    {
        id: 6, initials: 'RE', name: 'Rajasthan Electricals', type: 'Electrical Works',
        rating: 4.4, ratingCount: 20, projects: 20, value: '‚Çπ22L', valueNum: 22,
        onTime: 90, status: 'busy',
        specialties: ['Street Lights','Wiring','Transformers','Solar Panels'],
        phone: '98765 00000', location: 'Jaipur',
        licenseNo: 'RAJ-CON-2017-0055', gstNo: '08AABCR1122B1Z6',
        gradient: 'linear-gradient(135deg,#eab308,#facc15)',
        banner: 'linear-gradient(90deg,#b45309,#d97706)',
        perfBadge: null,
        completedProjects: [
            { name: 'Village Street Lighting', year: 2022, value: '‚Çπ5.6L', status: 'Verified' },
        ]
    },
];

var currentFilter = 'all';
var currentSearch = '';
var currentSort   = 'rating';

/* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ */
function escapeHtml(str) {
    return String(str)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

/* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded', function() {
    var user = GramSabha.requireAuth(['sarpanch']);
    if (!user) return;

    document.getElementById('sidebarUserName').textContent = user.name || '‚Äî';
    document.getElementById('sidebarAvatar').textContent   = user.avatar || (user.name || '  ').substring(0,2).toUpperCase();
    if (user.village) document.getElementById('sidebarUserRole').textContent = 'Sarpanch ‚Ä¢ ' + user.village;

    renderCards();

    /* Search */
    document.getElementById('searchInput').addEventListener('input', function() {
        currentSearch = this.value.toLowerCase();
        renderCards();
    });

    /* Filters */
    document.querySelectorAll('.ct-filter-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            currentFilter = this.dataset.filter;
            document.querySelectorAll('.ct-filter-btn').forEach(function(b) { b.classList.remove('active'); b.setAttribute('aria-pressed','false'); });
            this.classList.add('active'); this.setAttribute('aria-pressed','true');
            renderCards();
        });
    });

    /* Sort */
    document.getElementById('sortSelect').addEventListener('change', function() {
        currentSort = this.value; renderCards();
    });

    /* Add contractor */
    document.getElementById('addContractorBtn').addEventListener('click', function() {
        GramSabha.showNotification('üìã Add Contractor form ‚Äî coming soon!', 'info');
    });
});

/* ‚îÄ‚îÄ Render ‚îÄ‚îÄ */
function renderCards() {
    var filtered = contractors.filter(function(c) {
        var matchFilter = currentFilter === 'all' || c.status === currentFilter;
        var matchSearch = !currentSearch ||
            c.name.toLowerCase().includes(currentSearch) ||
            c.type.toLowerCase().includes(currentSearch) ||
            c.location.toLowerCase().includes(currentSearch) ||
            c.specialties.join(' ').toLowerCase().includes(currentSearch);
        return matchFilter && matchSearch;
    });

    filtered.sort(function(a,b) {
        if (currentSort === 'rating')   return b.rating - a.rating;
        if (currentSort === 'projects') return b.projects - a.projects;
        if (currentSort === 'value')    return b.valueNum - a.valueNum;
        if (currentSort === 'ontime')   return b.onTime - a.onTime;
        return 0;
    });

    /* Update summary */
    var avail = contractors.filter(function(c){return c.status==='available';}).length;
    var busy  = contractors.filter(function(c){return c.status==='busy';}).length;
    document.getElementById('statTotal').textContent = contractors.length;
    document.getElementById('statAvail').textContent = avail;
    document.getElementById('statBusy').textContent  = busy;
    document.getElementById('contractorSubtitle').textContent =
        filtered.length + ' of ' + contractors.length + ' contractors ‚Ä¢ ' + avail + ' available';

    var grid = document.getElementById('contractorGrid');
    if (!filtered.length) {
        grid.innerHTML = '<div class="ct-empty"><span class="material-symbols-outlined">manage_search</span><p>No contractors match your search.</p></div>';
        return;
    }

    grid.innerHTML = filtered.map(function(c) {
        var stars = Math.floor(c.rating);
        var starsHtml = '‚òÖ'.repeat(stars) + (c.rating % 1 >= 0.5 ? '¬Ω' : '') + '‚òÜ'.repeat(5 - Math.ceil(c.rating));
        var isAvail = c.status === 'available';
        var badgeHtml = c.perfBadge
            ? '<span class="ct-perf-badge" title="' + c.perfTitle + '" style="background:white;box-shadow:0 2px 8px rgba(0,0,0,.15)">' + c.perfBadge + '</span>'
            : '';

        return '<article class="ct-card" role="listitem" data-id="' + c.id + '">' +
          '<div class="ct-card-banner" style="background:' + c.banner + '" aria-hidden="true"></div>' +
          badgeHtml +
          '<div class="ct-card-header">' +
            '<div class="ct-avatar" style="background:' + c.gradient + '" aria-hidden="true">' + c.initials + '</div>' +
            '<span class="ct-status-tag ' + c.status + '">' +
              '<span class="material-symbols-outlined" aria-hidden="true">' + (isAvail ? 'check_circle' : 'pending') + '</span>' +
              (isAvail ? 'Available' : 'On Project') +
            '</span>' +
          '</div>' +
          '<div class="ct-info">' +
            '<h3 class="ct-name">' + escapeHtml(c.name) + '</h3>' +
            '<p class="ct-type">' + escapeHtml(c.type) + '</p>' +
            '<div class="ct-rating">' +
              '<span class="ct-stars" aria-hidden="true">' + starsHtml + '</span>' +
              '<span class="ct-rating-val">' + c.rating.toFixed(1) + '</span>' +
              '<span class="ct-rating-cnt">(' + c.projects + ' projects)</span>' +
            '</div>' +
            '<div class="ct-stats-row">' +
              '<div class="ct-mini-stat"><span class="ct-mini-val">' + c.projects + '</span><span class="ct-mini-lbl">Projects</span></div>' +
              '<div class="ct-mini-stat"><span class="ct-mini-val">' + c.value + '</span><span class="ct-mini-lbl">Total Value</span></div>' +
              '<div class="ct-mini-stat"><span class="ct-mini-val">' + c.onTime + '%</span><span class="ct-mini-lbl">On Time</span></div>' +
            '</div>' +
            '<div class="ct-ontime-row">' +
              '<div class="ct-ontime-top"><span class="ct-ontime-label">On-Time Delivery Rate</span><span class="ct-ontime-pct">' + c.onTime + '%</span></div>' +
              '<div class="ct-ontime-bar"><div class="ct-ontime-fill" style="width:' + c.onTime + '%"></div></div>' +
            '</div>' +
          '</div>' +
          '<div class="ct-tags">' +
            c.specialties.map(function(s){return '<span class="ct-tag">' + escapeHtml(s) + '</span>';}).join('') +
          '</div>' +
          '<div class="ct-contact">' +
            '<span class="ct-contact-item"><span class="material-symbols-outlined" aria-hidden="true">phone</span><a href="tel:' + c.phone.replace(/\s/g,'') + '">' + escapeHtml(c.phone) + '</a></span>' +
            '<span class="ct-contact-item"><span class="material-symbols-outlined" aria-hidden="true">location_on</span>' + escapeHtml(c.location) + '</span>' +
          '</div>' +
          '<div class="ct-actions">' +
            '<button class="ct-btn-profile" onclick="openProfile(' + c.id + ')" aria-label="View ' + escapeHtml(c.name) + ' profile">' +
              '<span class="material-symbols-outlined" aria-hidden="true">person_search</span>Profile' +
            '</button>' +
            (isAvail
              ? '<button class="ct-btn-assign" onclick="assignProject(\'' + escapeHtml(c.name) + '\')" aria-label="Assign project to ' + escapeHtml(c.name) + '">' +
                  '<span class="material-symbols-outlined" aria-hidden="true">assignment</span>Assign' +
                '</button>'
              : '<button class="ct-btn-assign busy-btn" disabled aria-label="' + escapeHtml(c.name) + ' is busy">' +
                  '<span class="material-symbols-outlined" aria-hidden="true">block</span>Busy' +
                '</button>'
            ) +
          '</div>' +
        '</article>';
    }).join('');
}

/* ‚îÄ‚îÄ Profile Drawer ‚îÄ‚îÄ */
function openProfile(id) {
    var c = contractors.find(function(x){ return x.id === id; });
    if (!c) return;
    var drawer  = document.getElementById('profileDrawer');
    var panel   = document.getElementById('drawerPanel');
    var content = document.getElementById('drawerContent');

    content.innerHTML =
        '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1.5rem">' +
          '<h2 style="font-size:1.125rem;font-weight:900;color:#0f172a;margin:0">Contractor Profile</h2>' +
          '<button onclick="closeDrawer()" style="background:none;border:none;cursor:pointer;padding:.375rem;border-radius:50%;background:#f1f5f9" aria-label="Close profile">' +
            '<span class="material-symbols-outlined" style="font-size:1.25rem;color:#475569">close</span>' +
          '</button>' +
        '</div>' +
        '<div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.25rem">' +
          '<div style="width:72px;height:72px;border-radius:50%;background:' + c.gradient + ';display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:900;color:white;flex-shrink:0">' + c.initials + '</div>' +
          '<div>' +
            '<h3 style="font-size:1.25rem;font-weight:900;color:#0f172a;margin:0 0 .2rem">' + escapeHtml(c.name) + '</h3>' +
            '<p style="font-size:.875rem;color:#64748b;margin:0 0 .5rem">' + escapeHtml(c.type) + '</p>' +
            '<span style="padding:.25rem .75rem;border-radius:999px;font-size:.6875rem;font-weight:800;background:' + (c.status==='available'?'#dcfce7;color:#166534':'#fef3c7;color:#92400e') + '">' + (c.status==='available'?'‚úì Available':'‚è≥ On Project') + '</span>' +
          '</div>' +
        '</div>' +
        '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:.625rem;margin-bottom:1.25rem">' +
          ['<b>'+c.projects+'</b><span>Projects</span>', '<b>'+c.value+'</b><span>Work Value</span>', '<b>'+c.onTime+'%</b><span>On Time</span>'].map(function(s){return '<div style="text-align:center;padding:.75rem;background:#f8fafc;border-radius:.875rem"><div style="font-size:1.125rem;font-weight:900;color:#0f172a">'+s.split('<b>')[1].split('</b>')[0]+'</div><div style="font-size:.6875rem;color:#94a3b8;font-weight:700;text-transform:uppercase;margin-top:.125rem">'+s.split('<span>')[1].split('</span>')[0]+'</div></div>';}).join('') +
        '</div>' +
        '<div style="margin-bottom:1rem">' +
          '<p style="font-size:.6875rem;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:#94a3b8;margin:0 0 .625rem">License & GST</p>' +
          '<div style="display:flex;flex-direction:column;gap:.375rem">' +
            '<div style="display:flex;justify-content:space-between;padding:.5rem .75rem;background:#f8fafc;border-radius:.625rem"><span style="font-size:.8125rem;color:#64748b;font-weight:600">License No.</span><span style="font-size:.8125rem;font-weight:700;color:#0f172a">' + c.licenseNo + '</span></div>' +
            '<div style="display:flex;justify-content:space-between;padding:.5rem .75rem;background:#f8fafc;border-radius:.625rem"><span style="font-size:.8125rem;color:#64748b;font-weight:600">GST No.</span><span style="font-size:.8125rem;font-weight:700;color:#0f172a">' + c.gstNo + '</span></div>' +
          '</div>' +
        '</div>' +
        '<div style="margin-bottom:1.25rem">' +
          '<p style="font-size:.6875rem;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:#94a3b8;margin:0 0 .625rem">Specialties</p>' +
          '<div style="display:flex;flex-wrap:wrap;gap:.375rem">' +
            c.specialties.map(function(s){return '<span style="padding:.25rem .75rem;border-radius:999px;background:#f1f5f9;font-size:.75rem;font-weight:700;color:#475569">'+escapeHtml(s)+'</span>';}).join('') +
          '</div>' +
        '</div>' +
        '<div style="margin-bottom:1.5rem">' +
          '<p style="font-size:.6875rem;font-weight:800;text-transform:uppercase;letter-spacing:.1em;color:#94a3b8;margin:0 0 .625rem">Recent Projects</p>' +
          c.completedProjects.map(function(p){
            return '<div style="display:flex;align-items:center;justify-content:space-between;padding:.75rem;background:#f8fafc;border-radius:.875rem;margin-bottom:.375rem">' +
              '<div><p style="font-size:.875rem;font-weight:700;color:#0f172a;margin:0 0 .125rem">'+escapeHtml(p.name)+'</p><p style="font-size:.75rem;color:#94a3b8;margin:0">'+p.year+' ¬∑ '+p.value+'</p></div>' +
              '<span style="padding:.2rem .6rem;border-radius:999px;font-size:.625rem;font-weight:800;background:#dcfce7;color:#166534">'+escapeHtml(p.status)+'</span>' +
            '</div>';
          }).join('') +
        '</div>' +
        (c.status === 'available'
          ? '<button onclick="assignProject(\''+escapeHtml(c.name)+'\');closeDrawer();" style="width:100%;padding:.875rem;background:linear-gradient(135deg,#16a34a,#22c55e);color:white;border:none;border-radius:.875rem;font-size:.9375rem;font-weight:800;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:.5rem">'+
              '<span class="material-symbols-outlined" style="font-size:1.125rem">assignment</span>Assign Project to ' + escapeHtml(c.name) + '</button>'
          : '<div style="padding:1rem;background:#fef3c7;border-radius:.875rem;text-align:center;font-size:.875rem;font-weight:700;color:#92400e">Currently on an active project ‚Äî not available for new assignment</div>'
        );

    drawer.style.display = 'block';
    setTimeout(function(){ panel.style.transform = 'translateX(0)'; }, 10);
}

function closeDrawer() {
    var panel  = document.getElementById('drawerPanel');
    var drawer = document.getElementById('profileDrawer');
    panel.style.transform = 'translateX(100%)';
    setTimeout(function(){ drawer.style.display = 'none'; }, 300);
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeDrawer();
});

/* ‚îÄ‚îÄ Assign ‚îÄ‚îÄ */
function assignProject(name) {
    GramSabha.showNotification('üìã Opening assignment for: ' + name, 'success');
    setTimeout(function(){ window.location.href = 'community-issues.html'; }, 1200);
}
</script>
</body>
</html>
