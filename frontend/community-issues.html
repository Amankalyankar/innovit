<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Issues | GRAM-SABHA</title>
    <meta name="description" content="View and manage all community reported issues">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/admin.css">
</head>
<body class="admin-body">
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="sidebar-logo">
                    <div class="sidebar-logo-icon">
                        <span class="material-symbols-outlined">account_balance</span>
                    </div>
                    <div class="sidebar-logo-text"><p class="sidebar-brand-name"><strong>GRAM-SABHA</strong></p>
                        <p>Sarpanch Portal</p>
                    </div>
                </a>
            </div>
            
            <nav class="sidebar-nav" aria-label="Main navigation">
                <a href="sarpanch-portal.html" class="nav-item">
                    <span class="material-symbols-outlined">dashboard</span>
                    <span>Dashboard</span>
                </a>
                <a href="pending-approvals.html" class="nav-item">
                    <span class="material-symbols-outlined">task_alt</span>
                    <span>Pending Approvals</span>
                    <span class="nav-badge">5</span>
                </a>
                <a href="active-projects.html" class="nav-item">
                    <span class="material-symbols-outlined">construction</span>
                    <span>Active Projects</span>
                </a>
                <a href="public-ledger.html" class="nav-item">
                    <span class="material-symbols-outlined">account_balance_wallet</span>
                    <span>Budget & Funds</span>
                </a>
                <a href="community-issues.html" class="nav-item active">
                    <span class="material-symbols-outlined">campaign</span>
                    <span>Community Issues</span>
                    <span class="nav-badge warning">12</span>
                </a>
                <a href="contractor-verification.html" class="nav-item">
                    <span class="material-symbols-outlined">verified</span>
                    <span>Work Verification</span>
                </a>
                <a href="contractors.html" class="nav-item">
                    <span class="material-symbols-outlined">groups</span>
                    <span>Contractors</span>
                </a>
            </nav>

            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-avatar" id="sidebarAvatar">RK</div>
                    <div class="sidebar-user-info">
                        <p class="sidebar-user-name" id="sidebarUserName">Ramesh Kumar</p>
                        <p class="sidebar-user-role">Sarpanch ‚Ä¢ Rampur</p>
                    </div>
                    <button onclick="GramSabha.logout()" class="sidebar-logout" aria-label="Logout">
                        <span class="material-symbols-outlined">logout</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <header class="admin-header">
                <div class="header-title"><h1 class="page-heading">Community Issues</h1>
                    <p>12 open issues reported by villagers</p>
                </div>
                <div class="header-actions">
                    <div class="search-filter">
                        <span class="material-symbols-outlined">search</span>
                        <input type="text" placeholder="Search issues...">
                    </div>
                    <select class="filter-select">
                        <option value="">All Categories</option>
                        <option value="water">Water Supply</option>
                        <option value="roads">Roads & Paths</option>
                        <option value="electricity">Electricity</option>
                        <option value="sanitation">Sanitation</option>
                        <option value="education">Education</option>
                    </select>
                </div>
            </header>

            <div class="admin-content">
                <!-- Issues Stats -->
                <div class="issues-stats">
                    <div class="stat-pill urgent">
                        <span class="material-symbols-outlined">priority_high</span>
                        <span>3 Urgent</span>
                    </div>
                    <div class="stat-pill high">
                        <span class="material-symbols-outlined">arrow_upward</span>
                        <span>4 High Priority</span>
                    </div>
                    <div class="stat-pill normal">
                        <span class="material-symbols-outlined">remove</span>
                        <span>5 Normal</span>
                    </div>
                </div>

                <!-- Issues Table -->
                <div class="issues-table-container">
                    <table class="issues-table">
                        <caption class="visually-hidden">List of community issues reported in your village</caption>
                        <thead>
                            <tr>
                                <th scope="col">Issue</th>
                                <th scope="col">Category</th>
                                <th scope="col">Location</th>
                                <th scope="col">Votes</th>
                                <th scope="col">Status</th>
                                <th scope="col">Reported</th>
                                <th scope="col">Action</th>
                            </tr>
                        </thead>
                        <tbody id="issuesTableBody">
                            <!-- Filled from API -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script src="js/auth.js" data-api-base="http://127.0.0.1:5000"></script>
    <script src="js/app.js"></script>
<script src="js/mobile.js"></script>
    <script>
        var allIssues = [];

        document.addEventListener('DOMContentLoaded', async function() {
            const user = GramSabha.requireAuth(['sarpanch']);
            if (!user) return;

            document.getElementById('sidebarUserName').textContent = user.name || '‚Äî';
            document.getElementById('sidebarAvatar').textContent = user.avatar || (user.name || '').split(' ').map(function(n) { return n[0]; }).join('').slice(0, 2).toUpperCase() || '‚Äî';
            var roleEl = document.querySelector('.sidebar-user-role');
            if (roleEl && user.village) roleEl.textContent = 'Sarpanch ‚Ä¢ ' + user.village;

            var villageId = user.villageId || user.village_id;
            try {
                allIssues = await GramSabha.getIssues(villageId) || [];
                renderIssues(allIssues);
            } catch (e) {
                document.getElementById('issuesTableBody').innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted)">Could not load issues. Is the backend running?</td></tr>';
            }

            // Real-time search filter
            var searchEl = document.getElementById('issueSearch') || document.querySelector('input[type="search"], input[placeholder*="Search"]');
            if (searchEl) {
                searchEl.addEventListener('input', applyFilters);
            }
            // Category filter
            var catFilter = document.getElementById('categoryFilter') || document.querySelector('select');
            if (catFilter) {
                catFilter.addEventListener('change', applyFilters);
            }
        });

        function applyFilters() {
            var searchEl = document.getElementById('issueSearch') || document.querySelector('input[type="search"], input[placeholder*="Search"]');
            var catFilter = document.getElementById('categoryFilter') || document.querySelector('select');
            var query = (searchEl ? searchEl.value : '').toLowerCase();
            var cat = catFilter ? catFilter.value.toLowerCase() : '';
            var filtered = allIssues.filter(function(i) {
                var matchSearch = !query ||
                    (i.title || '').toLowerCase().includes(query) ||
                    (i.description || '').toLowerCase().includes(query) ||
                    (i.location || '').toLowerCase().includes(query);
                var matchCat = !cat || cat === 'all' || (i.category || '').toLowerCase() === cat;
                return matchSearch && matchCat;
            });
            renderIssues(filtered);
        }

        function renderIssues(issues) {
            var tbody = document.getElementById('issuesTableBody');
            if (!issues || !issues.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:2rem;color:var(--text-muted)">No issues match your filter.</td></tr>';
                return;
            }
            var catIcons = { water: 'üíß Water', roads: 'üõ§Ô∏è Roads', electricity: '‚ö° Electricity', sanitation: 'üóëÔ∏è Sanitation', education: 'üè´ Education' };
            tbody.innerHTML = issues.map(function(i) {
                var cat = (i.category || '').toLowerCase();
                var catLabel = escapeHtml(catIcons[cat] || i.categoryName || i.category || '‚Äî');
                var statusClass = escapeHtml((i.status || '').replace(/\s+/g, '-'));
                var statusLabel = escapeHtml(i.statusName || i.status || '‚Äî');
                var title = escapeHtml(i.title || '‚Äî');
                var desc = escapeHtml(i.description || '');
                var location = escapeHtml(i.location || '‚Äî');
                var dateStr = escapeHtml(GramSabha.formatDate(i.reportedDate || i.createdAt));
                var issueId = escapeHtml(String(i.id || ''));
                return '<tr class="' + (i.priority === 'urgent' ? 'urgent-row' : '') + '">' +
                    '<td><div class="issue-info"><strong>' + title + '</strong><span>' + desc + '</span></div></td>' +
                    '<td><span class="category-badge ' + escapeHtml(cat) + '">' + catLabel + '</span></td>' +
                    '<td>' + location + '</td>' +
                    '<td><div class="votes-cell"><span class="material-symbols-outlined" aria-hidden="true">thumb_up</span><span>' + (i.votes || 0) + '</span></div></td>' +
                    '<td><span class="status-badge ' + statusClass + '">' + statusLabel + '</span></td>' +
                    '<td>' + dateStr + '</td>' +
                    '<td><button class="action-btn-small" onclick="assignIssue(\'' + issueId + '\')" aria-label="Assign issue to contractor"><span class="material-symbols-outlined">assignment_ind</span></button></td>' +
                    '</tr>';
            }).join('');
        }

        function assignIssue(issueId) {
            GramSabha.showNotification('Opening contractor assignment for issue #' + issueId, 'info');
            setTimeout(function() { window.location.href = 'contractors.html?issue=' + encodeURIComponent(issueId); }, 500);
        }

        function viewIssue(name) {
            GramSabha.showNotification('Viewing details for: ' + escapeHtml(name), 'info');
        }
    </script>
</body>
</html>
